<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove Background from Image</title>
    <style>
        body {
            text-align: center;
        }
        #dropArea {
            border: 2px dashed #ccc;
            width: 300px;
            padding: 20px;
            margin: 20px auto;
            text-align: center;
            cursor: pointer;
        }
        #output {
            margin-top: 20px;
            display: none;
            text-align: center;
        }
        #originalImage, #convertedImage, #selectionMask {
            max-width: 100%;
            display: block;
            margin: 0 auto;
        }
        button {
            margin-top: 10px;
        }
        #controls {
            margin-top: 10px;
        }
        #blurSlider {
            width: 80%;
            margin: 0 auto;
        }
        #sharpenButton {
            margin-top: 10px;
        }
        #checkerboard {
            width: fit-content;
            height: fit-content;
            background:
                linear-gradient(45deg, #ccc 25%, transparent 25%),
                linear-gradient(-45deg, #ccc 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #ccc 75%),
                linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 0, 10px -10px, 0px 10px;
            display: inline-block;
        }
        #colorPicker {
            margin-top: 10px;
        }
        #brushSize {
            margin-top: 10px;
        }
        #tolerance {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="dropArea" ondrop="handleDrop(event)" ondragover="allowDrop(event)">
        <p>Drag and drop your image here or click to upload</p>
        <input type="file" accept="image/*" id="fileInput" style="display: none;">
    </div>
    <div id="output">
        <h2>Original Image</h2>
        <img id="originalImage" src="" alt="Original Image">
        <br><br>
        <h2>Selection Mask</h2>
        <div id="controls">
            <input type="range" id="blurSlider" min="0" max="10" value="0" onchange="applyBlur()">
            <button id="sharpenButton" onclick="sharpenSelectionMask()">Grow Selection</button>
        </div>
        <input type="color" id="colorPicker">
        <input type="number" id="brushSize" min="1" max="100" value="1">
        <input type="range" id="tolerance" min="0" max="255" value="10">
        <button onclick="createSelectionMask()">Create Selection Mask</button>
        <canvas id="selectionMask" style="border: 2px solid #000;"></canvas>
        <button onclick="removeBackground()">Remove Background</button>
        <br><br>
        <h2>Converted Image</h2>
        <div id="checkerboard">
            <img id="convertedImage" src="" alt="Converted Image">
        </div>
        <br><br>
        <a id="downloadLink" style="display: none;" download="output.png">Download PNG</a>
    </div>

    <script>
        let originalImage = document.getElementById('originalImage');
        let selectionMaskCanvas = document.getElementById('selectionMask');
        let colorPicker = document.getElementById('colorPicker');
        let brushSize = document.getElementById('brushSize');
        let tolerance = document.getElementById('tolerance');
        let blurSlider = document.getElementById('blurSlider');
        let sharpenButton = document.getElementById('sharpenButton');
        let output = document.getElementById('output');
        let convertedImage = document.getElementById('convertedImage');
        let downloadLink = document.getElementById('downloadLink');
        let selectionMaskCtx = selectionMaskCanvas.getContext('2d');
        let image = new Image();

        function handleDrop(event) {
            event.preventDefault();
            let file = event.dataTransfer.files[0];
            loadImage(file);
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        function loadImage(file) {
            let reader = new FileReader();
            reader.onload = function(event) {
                originalImage.src = event.target.result;
                output.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function createSelectionMask() {
            selectionMaskCanvas.width = originalImage.width;
            selectionMaskCanvas.height = originalImage.height;
            selectionMaskCtx.drawImage(originalImage, 0, 0);

            let imageData = selectionMaskCtx.getImageData(0, 0, selectionMaskCanvas.width, selectionMaskCanvas.height);
            let data = imageData.data;

            let targetColor = hexToRgb(colorPicker.value);
            let toleranceValue = parseInt(tolerance.value);

            for (let i = 0; i < data.length; i += 4) {
                let red = data[i];
                let green = data[i + 1];
                let blue = data[i + 2];

                let distance = Math.sqrt(Math.pow(red - targetColor.r, 2) +
                                         Math.pow(green - targetColor.g, 2) +
                                         Math.pow(blue - targetColor.b, 2));

                if (distance <= toleranceValue) {
                    // If color is within tolerance, set the pixel to black
                    data[i] = 0;
                    data[i + 1] = 0;
                    data[i + 2] = 0;
                } else {
                    // Otherwise, set the pixel to white
                    data[i] = 255;
                    data[i + 1] = 255;
                    data[i + 2] = 255;
                }

                // Set alpha channel to 255 (opaque)
                data[i + 3] = 255;
            }

            selectionMaskCtx.putImageData(imageData, 0, 0);

            // Apply blur after creating the mask
            applyBlur();
        }

        function applyBlur() {
            let size = parseInt(blurSlider.value);
            selectionMaskCtx.filter = `blur(${size}px)`;
            selectionMaskCtx.drawImage(selectionMaskCanvas, 0, 0);
            selectionMaskCtx.filter = 'none';
        }

        function sharpenSelectionMask() {
            let imageData = selectionMaskCtx.getImageData(0, 0, selectionMaskCanvas.width, selectionMaskCanvas.height);
            let data = imageData.data;

            let colorCounts = new Array(256).fill(0);
            let totalPixels = 0;

            for (let i = 0; i < data.length; i += 4) {
                let luminance = Math.round(0.2126 * data[i] + 0.7152 * data[i + 1] + 0.0722 * data[i + 2]);
                colorCounts[luminance]++;
                totalPixels++;
            }

            let quarterPercentile = Math.floor(totalPixels / 4);

            let sum = 0;
            let threshold = 0;

            for (let i = 0; i < 256; i++) {
                sum += colorCounts[i];
                if (sum > quarterPercentile) {
                    threshold = i;
                    break;
                }
            }

            for (let i = 0; i < data.length; i += 4) {
                let luminance = Math.round(0.2126 * data[i] + 0.7152 * data[i + 1] + 0.0722 * data[i + 2]);

                if (luminance > threshold) {
                    // Set pixel to white
                    data[i] = 255;
                    data[i + 1] = 255;
                    data[i + 2] = 255;
                } else if (luminance <= 64) {
                    // Set pixel to black
                    data[i] = 0;
                    data[i + 1] = 0;
                    data[i + 2] = 0;
                } else {
                    // Gradual transition from white to black
                    let ratio = (luminance - 64) / (threshold - 64);
                    let colorValue = Math.round(255 * ratio);

                    data[i] = colorValue;
                    data[i + 1] = colorValue;
                    data[i + 2] = colorValue;
                }

                // Set alpha channel to 255 (opaque)
                data[i + 3] = 255;
            }

            selectionMaskCtx.putImageData(imageData, 0, 0);

            // Apply blur after sharpening
            //applyBlur();
        }

        function removeBackground() {
            let tempCanvas = document.createElement('canvas');
            tempCanvas.width = originalImage.width;
            tempCanvas.height = originalImage.height;
            let tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(originalImage, 0, 0);

            let selectionImageData = selectionMaskCtx.getImageData(0, 0, selectionMaskCanvas.width, selectionMaskCanvas.height);
            let selectionData = selectionImageData.data;

            let imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            let data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                let alpha = selectionData[i]; // Use alpha from the selection mask
                data[i + 3] = alpha; // Apply transparency from the selection mask
            }

            tempCtx.putImageData(imageData, 0, 0);
            convertedImage.src = tempCanvas.toDataURL('image/png');

            // Show download link
            downloadLink.href = tempCanvas.toDataURL('image/png');
            downloadLink.style.display = 'inline';
        }

        function hexToRgb(hex) {
            // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
            let shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, function(m, r, g, b) {
                return r + r + g + g + b + b;
            });

            let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
    </script>
</body>
</html>
